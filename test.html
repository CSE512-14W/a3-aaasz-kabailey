<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <style>
      html, body, #map-canvas {
        width: 70%;
        height: 80%;
        margin-left: 5%;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }

      .axis {
          font: 10px sans-serif;
          -webkit-user-select: none;
          -moz-user-select: none;
          user-select: none;
      }

      .axis .domain {
          fill: none;
          stroke: #000;
          stroke-opacity: .3;
          stroke-width: 10px;
          stroke-linecap: round;
      }

      .axis .halo {
          fill: none;
          stroke: #ddd;
          stroke-width: 8px;
          stroke-linecap: round;
      }

      .slider .handle {
          fill: #fff;
          stroke: #000;
          stroke-opacity: .5;
          stroke-width: 1.25px;
          pointer-events: none;
      }


    </style>
    <script src="datetimepicker.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>
    
    <script>
        var margin = {top: 200, right: 50, bottom: 200, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.bottom - margin.top;
        var map;
        var heatmap;
        var filter_date = new Date("1960-01-01");
        var heatmap_data;
        var slider, handle, svg;
        var crt_position;
        var total_positions;

        // info about the current choices in displaying the data
        var start_date;
        var end_date;
        var granularity;
        var crt_data_rows;
        var crt_sum_points;
        //

        var data_rows;
        var x = d3.time
                  .scale()
                  .range([0, width])
                  .clamp(true);

        var brush = d3.svg.brush()
                      .x(x)
                      .extent([0, 0])
                      .on("brush", brushed);
                

        window.onload = function () {
            d3.csv("data_200000.csv", parse_types, function(error, data) {
                data_rows = data;
                // data is sorted - most recent in pos 0
                total_positions = data_rows.length;
                crt_position = total_positions - 1;
                
                x.domain(d3.extent(data_rows, function(d) { return d["Event Clearance Date"]; }))

                svg = d3.select("#slider").append("svg")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                            .append("g")
                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                svg.append("g")
                   .attr("class", "x axis")
                   .attr("transform", "translate(0," + height / 2 + ")")
                   .call(d3.svg.axis()
                               .scale(x)
                               .orient("bottom")
                               .tickFormat(d3.time.format('%b %Y'))
                               .tickSize(0)
                               .tickPadding(12))
                   .select(".domain")
                   .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
                   .attr("class", "halo");

                slider = svg.append("g")
                                .attr("class", "slider")
                                .call(brush);

                slider.selectAll(".extent,.resize")
                      .remove();

                slider.select(".background")
                      .attr("height", height);

                handle = slider.append("circle")
                                   .attr("class", "handle")
                                   .attr("transform", "translate(0," + height / 2 + ")")
                                   .attr("r", 9);
        
                initialize_map();
                //make Update button visible
                document.getElementById("submit").type = "submit";
            });
        }
        
        var parseDate = d3.time.format("%m/%d/%Y %I:%M:%S %p").parse;

        function parse_types(d) {
            d["Latitude"] = +d["Latitude"];
            d["Longitude"] = +d["Longitude"];
            d["Event Clearance Date"] = parseDate(d["Event Clearance Date"]);
            return d;
        }
        
        function brushed() {
            var value = brush.extent()[0];

            if (d3.event.sourceEvent) { // not a programmatic event
                value = x.invert(d3.mouse(this)[0]);
                brush.extent([value, value]);
            }
            if (filter_date.getTime() < value.getTime())
                add_points_to_map(value);
            
            if (filter_date.getTime() > value.getTime())
                remove_points_from_map(value);
    
            filter_date = value;
            handle.attr("cx", x(value));
            //d3.select("body").style("background-color", d3.hsl(value, .8, .8));
        }

        function update() {
            var start_date_t = new Date(document.getElementById('start_date').value);
            var end_date_t = new Date(document.getElementById('end_date').value);
            var time_granularity_t = document.getElementById("time_granularity").value;

            get_points(start_date_t, end_date_t);
            console.log("Got " + crt_data_rows.length);
            get_points_by_granularity(time_granularity_t);
        }

        //avoid too many comparisons - break into multiple whiles
        function get_points(start_date_t, end_date_t) {
            var pos = 0;           
            
            while((pos < total_positions) && (data_rows[pos]["Event Clearance Date"].getTime() > end_date_t.getTime())) {
                pos++;
            }

            crt_data_rows = [];
            
            while((pos < total_positions) && (data_rows[pos]["Event Clearance Date"].getTime() >= start_date_t.getTime())) {
                crt_data_rows.push(data_rows[pos]);
                pos++;
            }
        }

        function get_points_by_granularity(granularity_t) {
            var g;
            switch (granularity_t) {
                case "day":
                    g = function(d){d_t = d["Event Clearance Date"]; return new Date(d_t.getFullYear(), d_t.getMonth(), d_t.getDate());};
                    break;
                case "month":
                    g = function(d){d_t = d["Event Clearance Date"]; return new Date(d_t.getFullYear(), d_t.getMonth());};
                    break;
                case "year":
                    g = function(d){d_t = d["Event Clearance Date"]; return d_t.getFullYear();};
            }
            console.log(g);
            crt_sum_points = d3.nest()
                               .key(g) // `GROUP BY date`
                               .rollup(function(values){
                                           return values.length;})
                               .entries(crt_data_rows);
            console.log(crt_sum_points);
        }

        function add_points_to_map(date_value) {
           while((crt_position > 0) && (data_rows[crt_position]["Event Clearance Date"].getTime() <= date_value.getTime())) {
               heatmap_data.push(new google.maps.LatLng(data_rows[crt_position]["Latitude"], data_rows[crt_position]["Longitude"]));
               crt_position--;
           }
        }
 
        function remove_points_from_map(date_value) {
           while((crt_position < total_positions - 1) && (data_rows[crt_position]["Event Clearance Date"].getTime() >= date_value.getTime())) {
               heatmap_data.pop();
               crt_position++;
           }
        }

        function generate_points(data_rows, filter) {
            //distress_calls_data = [];
            for (var row in data_rows) {
                //if (filter(row))  
                heatmap_data.push(new google.maps.LatLng(data_rows[row]["Latitude"], data_rows[row]["Longitude"]));
            }
        }

        function initialize_map() {
            var mapOptions = {
                zoom: 11,
                center: new google.maps.LatLng(47.6097, -122.3331),
                mapTypeId: google.maps.MapTypeId.SATELLITE
            };
            map = new google.maps.Map(document.getElementById('map-canvas'),
                                      mapOptions);

            heatmap_data = new google.maps.MVCArray();

            heatmap = new google.maps.visualization.HeatmapLayer({
                          data: heatmap_data
            });

            heatmap.setMap(map);
        }

        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
        }

        function changeGradient() {
            var gradient = [
                'rgba(0, 255, 255, 0)',
                'rgba(0, 255, 255, 1)',
                'rgba(0, 191, 255, 1)',
                'rgba(0, 127, 255, 1)',
                'rgba(0, 63, 255, 1)',
                'rgba(0, 0, 255, 1)',
                'rgba(0, 0, 223, 1)',
                'rgba(0, 0, 191, 1)',
                'rgba(0, 0, 159, 1)',
                'rgba(0, 0, 127, 1)',
                'rgba(63, 0, 91, 1)',
                'rgba(127, 0, 63, 1)',
                'rgba(191, 0, 31, 1)',
                'rgba(255, 0, 0, 1)'
            ]
            heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
        }

        function changeRadius() {
            heatmap.set('radius', heatmap.get('radius') ? null : 20);
        }

        function changeOpacity() {
            heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
        }

    </script>
  </head>

  <body>
      <table width="1500px" border="0">
          <tr>
              <td colspan="2" style="background-color:#FFA500;">
                  <h1>911 Calls - Seattle</h1>
                  <div id="panel">
                      <button onclick="toggleHeatmap()">Toggle Heatmap</button>
                      <button onclick="changeGradient()">Change gradient</button>
                      <button onclick="changeRadius()">Change radius</button>
                      <button onclick="changeOpacity()">Change opacity</button>
                  </div>
              </td>
          </tr>

          <tr>
              <td style="background-color:#FFD700;width:400px; height:500px">
                  <div id="map-canvas" style="width:90%; height:100%"></div>
              </td>
              <td style="background-color:#EEEEEE;height:200px;width:400px;">
                        <form name="updates" action="javascript:update()">
	  		    Start date:<br>
	  		    <input type="text" id="start_date" name = "Start date" maxlength="25" size="25"><a href="javascript:NewCal('start_date','ddmmmyyyy',true,24)"><img src="images/cal.gif" width="16" height="16" border="0" alt="Pick a date"></a><br>
	  		    <br>
                            End date:<br>
	  		    <input type="text" id="end_date" name = "End date" maxlength="25" size="25"><a href="javascript:NewCal('end_date','ddmmmyyyy',true,24)"><img src="images/cal.gif" width="16" height="16" border="0" alt="Pick a date"></a><br>
                            Ticks:
                            <select name="time_granularity" id="time_granularity">
                                <option value="day">Day</option>
                                <option value="month" selected>Month</option>
                                <option value="year">Year</option>
                            </select>
                            <br><br>
                            Show only:
                            <br>
                            <input type="checkbox" name="Traffic related calls" value="Traffic">Traffic related calls<br>
                            <input type="checkbox" name="Suspicious circumstances" value="Suspicious">Suspicious circumstances<br>
                            <input type="checkbox" name="Other" value="Other">Other<br>
                            <input type="checkbox" name="All" value="All">All<br>
                            <br>
                            <input type="hidden" name="Submit" id="submit" value="Update" />
                        </form>
              </td>
          </tr>
          <tr>
              <td colspan="2" style="background-color:#FFA500;text-align:center;">
                  <div id="slider"></div>
              </td>
          </tr>
      </table>
  </body>
</html>


